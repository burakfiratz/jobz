<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<title>Jobz</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/scripts/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="/scripts/jquery-ui-dist/jquery-ui.min.css" rel="stylesheet">
</head>
<body>

<div class="container">
  <div class="row">
    <div class="col">
			<form id="jobForm">
				<div class="form-group">
					<label>Job title</label>
					<input id="jobTitle" type="text" class="form-control" placeholder="Enter job title">
				</div>
				<div class="form-group">
					<label>Job description</label>
					<textarea id="jobDescription" class="form-control" rows="3"></textarea>
				</div>
				<button type="submit" class="btn btn-primary">Submit</button>
			</form>
    </div>
    <div id="firstPhase" class="col list-group">
				<a href="#" class="list-group-item list-group-item-action">Cras justo odio</a>
				<a href="#" class="list-group-item list-group-item-action">Dapibus ac facilisis in</a>
				<a href="#" class="list-group-item list-group-item-action">Morbi leo risus</a>
				<a href="#" class="list-group-item list-group-item-action">Porta ac consectetur ac</a>
				<a href="#" class="list-group-item list-group-item-action">Vestibulum at eros</a>
				<div data-guid="05308c7d-e559-4c5e-95e3-a27d30b96627" data-phase="firstPhase" class="card bg-light mb-3">
					<div class="card-header ui-state-default">ööö</div>
				<div class="card-body">
					<p class="card-text">çççç</p>
				</div>
				</div>
    </div>
    <div id="progressPhase" class="col list-group">
    </div>
		<div id="donePhase" class="col  list-group">
    </div>
  </div>
</div>








<script src="/scripts/jquery/dist/jquery.min.js"></script>
<script src="/scripts/jquery-ui-dist/jquery-ui.min.js"></script>
<script src="/scripts/popper.js/dist/popper.min.js"></script>
<script src="/scripts/tooltip.js/dist/tooltip.min.js"></script>
<script src="/scripts/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
$( document ).ready(function() {
	let socket = io();
	$("#jobForm").submit(function(e){
		e.preventDefault();
		let jobTitle = $("#jobTitle").val();
		let jobDescription = $("#jobDescription").val();
		socket.emit('newJob', { guid : uuidv4(), jobTitle : jobTitle, jobDescription : jobDescription, phase : 'firstPhase' } );
	});
	
	socket.on("addNewJob", function(data){
		//let divCard = cardSkeleton(data);
		let divCard = listGroupSkeleton(data);
		$("#firstPhase").append(divCard);
	});
	
	socket.on('welcome', function(data){
		let divCard;
		data.forEach(function(item) {
				//divCard=cardSkeleton(item);
				divCard = listGroupSkeleton(item);
				if(item.phase === 'firstPhase')
					$("#firstPhase").append(divCard);
				else if(item.phase === 'progressPhase')
					$("#progressPhase").append(divCard);
				else
					$("#donePhase").append(divCard);
		});
	});
	
	
	$("#firstPhase, #progressPhase, #donePhase").sortable({
		connectWith: ".list-group",
			change: function(e, ui) {
				//console.log(ui.item.parent()[0].id);
		},
		update: function(e, ui) {
				if (this === ui.item.parent()[0]) {
					updateJobPhase(ui.item.data("guid"), ui.item.data("phase"), ui.item.parent()[0].id);
				}
      }
	});
	
	/*
	$("#firstPhase, #progressPhase, #donePhase").sortable({
      connectWith: ".col",
			change: function(e, ui) {
				//console.log(ui.item.parent()[0].id);
			},
			update: function(e, ui) {
				if (this === ui.item.parent()[0]) {
					updateJobPhase(ui.item.data("guid"), ui.item.data("phase"), ui.item.parent()[0].id);
				}
      }
    }).disableSelection();
	*/
	
	socket.on('sendUpdatedJobPhase', function(data){
			$('*[data-guid="'+ data.guid +'"]').remove();
			//let divCard = cardSkeleton(data);
			let divCard = listGroupSkeleton(data);
			$('#'+data.phase).append(divCard);
			
			/*
			$('*[data-guid="'+ data.guid +'"]').removeClass (function (index, classname) {
				return (classname.match (/bg-[a-z]* /) || []).join(' ');
			});
			
			/*
			if(data.phase === 'firstPhase')
				$('*[data-guid="'+ data.guid +'"]').addClass('bg-primary');
			else if(data.phase === 'progressPhase')
				$('*[data-guid="'+ data.guid +'"]').addClass('bg-warning');
			else
				$('*[data-guid="'+ data.guid +'"]').addClass('bg-success');
			*/
		});
		
		function updateJobPhase(jobGuid, oldPhaseName, newPhaseName){
			$('*[data-guid="'+ jobGuid +'"]').remove();
			socket.emit('updateJobPhase', { jobGuid : jobGuid, phaseName : newPhaseName });
		}
		
		function listGroupSkeleton(data){
			return '<a href="#" class="list-group-item list-group-item-action" '+
						'data-guid="'+ data.guid +'" '+
						'data-phase="'+ data.phase +'" '+
						'>'+
						data.jobTitle+
						'</a>';
		}
	
		function cardSkeleton(data){
				return '<div '+
				'data-guid="'+ data.guid +'" '+
				'data-phase="'+ data.phase +'" '+
				'class="card bg-light mb-3">'+
					'<div class="card-header ui-state-default">'+
				data.jobTitle +
				'</div>'+
				'<div class="card-body">'+
					'<p class="card-text">'+ data.jobDescription +'</p>'+
				'</div>'+
				'</div>';
			}
		
		function uuidv4() {
			return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
				(c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
			)
		}
	
});
</script>
</body>
</html>



